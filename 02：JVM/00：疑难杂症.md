### 疑难杂症

------

[TOC]

##### 01：系统变慢、不可用排查流程

- 导出 jstack 和内存信息，然后重启系统。
- 通过 **`top`命令**查看CPU情况，如果CPU比较高，则通过 **`top-Hp <pid>`命令**查看当前进程的各个线程运行情况，找出CPU过高的线程之后，将其**线程id转换为十六进制**的表现形式，然后在 **jstack日志** 中查看该线程主要在进行的工作。这里又分为两种情况
- 如果是正常的用户线程，则通过该线程的堆栈信息查看其具体是在哪处用户代码处运行比较消耗CPU；
- 如果该线程**是 `VM Thread`**，则通过 **`jstat -gcutil <pid> <period> <times>`命令监控当前系统的GC状况**，然后通过 **`jmapdump:format=b,file=<filepath><pid>`导出系统当前的内存数据**。导出之后将内存情况放到 **idea 的 profiler** 工具中进行分析即可得出内存中主要是什么对象比较消耗内存，进而可以处理相关代码；
- 如果通过 `top` 命令看到 CPU 并不高，并且系统内存占用率也比较低。此时就可以考虑是否是由于另外三种情况导致的问题。具体的可以根据具体情况分析：
  1. **不定期出现的接口耗时现象**：如果是接口调用比较耗时，并且是不定时出现，则可以通过**压测的方式加大阻塞点出现的频率**，从而通过 `jstack`查看堆栈信息，找到阻塞点；
  2. **某个线程进入WAITING状态**：如果是某个功能突然出现停滞的状况，这种情况也无法复现，此时可以**通过多次导出 `jstack`日志的方式对比哪些用户线程是一直都处于等待状态**，这些线程就是可能存在问题的线程；
  3. **死锁**：如果通过 `jstack`可以查看到死锁状态，则可以检查产生死锁的两个线程的具体阻塞点，从而处理相应的问题。

##### 02：

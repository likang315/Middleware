### Redis 持久化

------

[TOC]

##### 01：概述

- 因为 Redis 是内存数据库， 它将自己数据库中的数据储存在内存里面， 所以如果不想办法将储存在内存中的数据库状态保存到磁盘里面， 那么一旦服务器进程退出， 服务器中的数据库的数据也会消失不见。
- 两种持久化机制：RDB持久化和AOF持久化

##### 02：RDB 文件的创建和载入

- RDB持久化的两种方式
  - SAVE
    - SAVE命令会阻塞Redjs 服务器进程， 直到RDB 文件创建完毕为止， 在服务器进程阻塞期间， 服务器不能处理任何命令请求：
  - BGSAVE
    - 派生出一个子进程，然后由子进程负责创建RDB 文件，服务器进程（ 父进程） 继续处理命令请求；
  - 创建 RDB 文件的实际工作由 **rdb.c/rdbSave** 函数完成， SAVE命令和BGSAVE 命令以不同的方式调用这个函数；
- RDB 文件的载入
  - 在服务器启动时自动执行的，所以 Redis 并没有专门用于载入 RDB 文件的命令，只要 Redis 服务器在启动时检测到 RDB 件存在， 它就会自动载入RDB 文件。
  - 载入RDB文件期间，服务器处于阻塞状态，直至载入完成为止；
  - 载入文件的工作由 **rdb.c/rdbLoad** 函数完成；
- 载入文件的优先级
  - 由于AOF的更新频率更高，因此只有**在 AOF 持久化功能处于关闭状态时**， 服务器才会使用 RDB 文件来还原数据库状态。

##### 03：SAVE 命令执行时的服务器状态

- SAVE、BGSAVE、BGREWRITEAOF  三者关系
  - SAVE 命令执行期间，拒绝一切命令；
  - BGSAVE 命令执行期间，禁止SAVE执行（父子进程竞争），BGREWRITEAOF 命令会延迟到BGSAVE命令执行完成之后执行；
  - BGREWRITEAOF  命令执行期间，拒绝以上两个命令执行；

##### 04：自动间隔性保存

- Redis 允许用户通过设置服务器配置的 save 选项， 让服务器**每隔一段时间自动执行一次 BGSAVE 命令**；
- 可以通过 save 选项设置多个保存条件， 但只要其中任意一个条件被满足， 服务器就会执行命令。

###### 设置保存条件

- 
















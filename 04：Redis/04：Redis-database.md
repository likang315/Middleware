### 数据库

------

[TOC]

##### 01：服务器中的数据库

- Redis 服务器将所有数据库都保存在服务器状态redis.h/redis Server 结构的db数组中， db 数组的每个项都是一个redis.h/redisDb 结构， 每个redisDb 结构代表一个数据库：

- dbnum 的值由服务器配置的database选项决定，默认：16；

  - ```c
    struct redsiServer {
        // 一个数组，保存着服务器中所有的数据
        redisDb *db;
        // 初始化服务器时，决定应该创建多少个数据库
        int dbnum;
    }
    ```

##### 02：切换数据库

- 每个Redis 客户端都有自己的目标数据库， 每当客户端执行数据库命令的时候， 目标数据库就会成为这些命令的操作对象。
- 默认情况下， Redis 客户端的目标数据库为 0 号数据库， 但客户端可以通过执行 SELECT 命令来切换目标数据库。
- 在服务器内部， 客户端状态 redisClient 结构的 db 属性记录了客户端当前的目标数据库， 这个属性是一个指向redis Db 结构的指针，db 指针指向redis Serve r.db 数组的其中一个元素， 而被指向的元素就是客户端的目标数据库。
- <img src="/Users/likang/Code/Git/Middleware/04：Redis/photos/redis-database.png" style="zoom:40%;" />

##### 03：数据库键空间

- redisDb 结构的 **dict 字典**保存了数据库中的所有键值对，将这个字典称为键空间( key space ) 。

- 

  ```c
  typedef struct redisDb {
  	// 数据库空间，保存着数据库中所有的键值对【键空间】
  	dict *dict;
  	diet *expires;
  } redisDb;
  ```

###### redis-db 空间分布

<img src="/Users/likang/Code/Git/Middleware/04：Redis/photos/redis-db-space.png" style="zoom:30%;" />

- 实际上就是一个字典，对redis 的操作，就是对字典的增删改查；

###### 读取键空间时的维护操作

1. 在读取一个键之后（ 读操作和写操作都要对键进行读取）， 服务器会根据键是否存在来更新服务器的键空间命中( hit) 次数或键空间不命中( miss ) 次数， 这两个值可以在INFO stats 命令的keyspace_hits 和keyspace_misses属性查看。
2. 在读取一个键之后， 服务器会更新键的LRU （ 最后一次使用） 时间， 这个值可以用于计算键的闲置时间， 使用OBJECT idletime <key> 命令可以查看键key 的闲置时间。
3. 如果服务器在读取一个键时发现该键已过期， 那么服务器会先删除这个过期键，然后才执行余下的其他操作。

##### 04：设置键的过期时间

- 通过EXPIRE命令，客户端可以以秒或者亳秒精度为数据库中的某个键设置**生存时间( Time To Live , TTL )** , 在经过指定的秒数或者毫秒数之后， 服务器就会自动删除生存时间为0 的键（永久key：-1）。
- 过期时间是一个UN IX 时间戳，TTL 命令接受一个带有生存时间或者过期时间的键， 返回这个键的剩余生存时间；

###### 设置过期时间

- PEXPIREAT key  timestamp：命令用于将键 key 的过期时间设置为timestap所指定的毫秒数时间戳；
- 不管是哪个设置过期时间命令，最终都转换成该命令执行；
  - 伪代码：判断设置过期时间的key 是否存在键空间中，若存在，则设置，返回设置成功或失败；

###### 保存过期时间

- redisDb 结构的expires 字典保存了数据库中所有键的过期时间， 我们称这个字典为**过期字典**：
- 过期字典的键是一个指针， 这个指针指向键空间中的**某个键对象**（也即是某个数据库键）。
- 过期字典的值是一个long long 类型的整数， 这个整数保存了键所指向的数据库键的过期时间(毫秒精度的UNIX时间戳)。

###### 移除过期时间

- PEXPIREAT：设置key的过期时间；
- PERSIST：移除一个键的过期时间；
  - 从过期字典中，移除指定key；

###### 计算并返回剩余生存时间

- TTL 命令以秒为单位返回键的剩余生存时间；
  - 通过计算**键的过期时间和当前时间之间的差**来实现的；

###### 过期键的判定

1. 检查给定键是否存在千过期字典： 如果存在， 那么取得键的过期时间。
2. 检查当前UNIX 时间戳是否大于键的过期时间： 如果是的话， 那么键已经过期； 否则的话， 键未过期。

##### 05：过期键的删除策略

###### 定时删除

- 定时删除策略**对内存是最友好的**： 通过使用定时器， 定时删除策略可以保证过期键会尽可能快地被删除， 并释放过期键所占用的内存。
- 定时删除策略的缺点是： 它对CPU 时间是最不友好的，在过期键比较多的情况下， 删除过期键这一行为可能会占用相当一部分CPU 时间， 在**内存不紧张但是CPU 时间非常紧张**的情况下令将CPU 时间用在删除和当前任务无关的过期键上， 无疑会对服务器的响应时间和吞吐量造成影响。

###### 惰性删除

- 惰性删除策略**对CPU 时间来说是最友好的**： 程序只会在取出键时才对键进行过期检查，可以保证删除过期键的操作只会在非做不可的情况下进行， 并且删除的目标仅限于当前处理的键， 这个策略不会在删除其他无关的过期键上花费任何CPU 时间。
- 惰性删除策略的缺点是：它对内存是最不友好的，如果一个键已经过期， 而这个键又仍然保留在数据库中， 那么只要这个过期键不被删除， 它所占用的内存就不会释放。

###### 定期删除

- 定期删除策略是前两种策略的一种**整合和折中**：
- 定期删除策略每隔一段时间执行一次删除过期键操作， 并通过限制删除操作**执行的时长和频率**来减少删除操作对CPU 时间的影响。
- 通过定期删除过期键， 定期删除策略有效地减少了因为过期键而带来的内存浪费。
- 定期删除策略的难点是确定删除操作执行的时长和频率，设置不当，将退化为以上两种；

##### 06：Redis 的过期键删除策略

- Redis 服务器实际使用的是惰性删除和定期删除两种策略；

###### 惰性删除策略的实现

- 过期键的惰性删除策略由db.c /expireIfNeed  函数实现， 所有读写数据库的 Redis 命令在执行之前都调 用 expireIfNeed 函数对输人键进行检查：
  - 如果输入键已经过期， 那么 expireIfNeed 函数将输入键从数据库中删除；
  - 如果输入键未过期， 那么 expireIfNeed  函数不做动作；

###### 定期删除策略的实现

- 过期键的定期删除策略redis.c/activeExpireCycle 函数实现， 每当Redis 的服务器周期性操作 redis.c /server Cron 函数执行时，activeExpireCycle 函数就会被调用， 它在**规定的时间内， 分多次遍历服务器中的各个数据库， 从数据库的过期字典中随机检查一部分键的过期时间， 并删除其中的过期键**；
- Redis 默认会 ：**每秒进⾏⼗次过期扫描**，过期扫描不会遍历过期字典中的所有 key，采⽤简单的**贪⼼策略**:
  1. 从过期字典中随机选取 20个 key；
  2. 删除这 20个 key 中已经过期的；
  3. 如果过期 key 的比例超过 1/4，那么就重复步骤1；
  4. **从库不会进⾏过期扫描**，主库在 key 到期的时候，会**在 AOF ⽂件中增加⼀条 del 指令**，同步到所有从库；

##### 07：AOP、RDB 和复制功能对过期键的处理

###### 生成RDB文件

- 在执行 **SAVE 命令或者 BGSAVE 命令**创建一个新的RDB 文件时， 程序会对数据库中的键进行检查， 已过期的键不会被保存到新创建的RDB 文件中。

###### 载入RDB文件

- 如果服务器以**主服务器模式运行**， 那么在载入RDB 文件时， 程序会对文件中保存的键进行检查， 未过期的键会被载入到数据库中， 而过期键则会被忽略， 所以过期键对载入RDB 文件的主服务器不会造成影响。
- 如果服务器以**从服务器模式运行**， 那么在载入RDB 文件时， 文件中保存的所有键，不论是否过期， 都会被载入到数据库中。不过， 因为主从服务器在进行数据同步的时候， 从服务器的数据库的过期键就会被清空。

###### AOF文件写入

- 当服务器以 AOF 持久化模式运行时， **如果数据库中的某个键已经过期， 但它还没有被惰性删除或者定期删除， 那么AOF 文件不会因为这个过期键而产生任何影响**。当过期键被惰性删除或者定期删除之后， 程序会向AOF 文件追加( append ) 一条DEL 命令， 来显式地记录该键已被删除。

###### AOF重写

- 在执行AOF 重写的过程中， 程序会对数据库中的键进行检查， 已过期的键不会被保存到重写后的 AOF 文件中。

###### 复制

- 当服务器运行在**复制模式下**时， 从服务器的过期键删除动作由主服务器控制：
  1. 主服务器在删除一个过期键之后， 会显式地向所有从服务器发送一个DEL 命令， 告知从服务器删除这个过期键。
  2. 从服务器在执行客户端发送的读命令时， 即使碰到过期键也不会将过期键删除． 而是继续像处理未过期的键一样来处理过期键。
  3. 从服务器只有在接到主服务器发来的DEL 命令之后， 才会删除过期键.
- 为了保持数据的一致性；

##### 08：数据库通知

- 


















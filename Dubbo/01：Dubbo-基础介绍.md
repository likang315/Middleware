### Dubbo 基础介绍

------

- 随着网站应用的规模不断扩大，常规的垂直应用架构已无法应对，分布式服务架构以及流动计算架构势在必行，亟需一个治理系统确保架构有条不紊的演进；
- http://dubbo.apache.org/zh-cn/docs/user/new-features-in-a-glance.html

##### 01：背景

- ###### 单一应用架构

  - 当网站流量很小时，只需一个应用，将所有功能都部署在一起，以**减少部署节点和成本**。此时，用于简化增删改查工作量的数据访问框架(ORM)是关键；

- ###### 垂直应用架构

  - 当访问量逐渐增大，**单一应用增加机器带来的加速度越来越小**，提升效率的方法之一是**将应用拆成互不相干的几个应用**，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。

- ###### 分布式服务架构

  - 当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，**作为独立的服务，逐渐形成稳定的服务中心**，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的**分布式服务框架(RPC)**是关键。

- ###### 流动计算架构

  - 当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需**增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率**。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。

##### 02：需求

1. 当服务越来越多时，服务 URL 配置管理变得非常困难，F5 硬件负载均衡器的单点压力也越来越大。 此**时需要一个服务注册中心，动态地注册和发现服务，使服务的位置透明。并通过在消费方获取服务提供方地址列表，实现软负载均衡和 Failover**，降低对 F5 硬件负载均衡器的依赖，也能减少部分成本。
2. 当进一步发展，服务间依赖关系变得错踪复杂，甚至分不清哪个应用要在哪个应用之前启动，架构师都不能完整的描述应用的架构关系。 这时，**需要自动画出应用间的依赖关系图**，以帮助架构师理清关系。
3. 接着，服务的调用量越来越大，服务的容量问题就暴露出来，这个服务需要多少机器支撑？什么时候该加机器？ 为了解决这些问题，第一步，**要将服务现在每天的调用量，响应时间，都统计出来，作为容量规划的参考指标。其次，要可以动态调整权重，在线上，将某台机器的权重一直加大，并在加大的过程中记录响应时间的变化，直到响应时间到达阈值，记录此时的访问量，再以此访问量乘以机器数反推总容量**。

##### 03：Dubbo 的服务架构

![Dubbo](file:///Users/likang/Code/Git/Middleware/Dubbo/photos/Dubbo.png?lastModify=1599722814)

###### 节点角色

| 节点      | 角色说明                               |
| --------- | -------------------------------------- |
| Provider  | 暴露服务的服务提供方                   |
| Consumer  | 调用远程服务的服务消费方               |
| Registry  | 服务注册与发现的注册中心               |
| Monitor   | 统计服务的调用次数和调用时间的监控中心 |
| Container | 服务运行容器                           |

###### 调用关系说明

1. 启动容器，加载，**运行服务提供者**。
2. 服务提供者在启动时，在注册中心**发布注册**自己提供的**服务**。
3. 服务消费者在启动时，在注册中心**订阅**自己所需的**服务**。
4. 注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。
5. 服务消费者，从提供者地址列表中，基于**软负载均衡算法**，选一台提供者进行调用，如果调用失败，再选另一台调用。
6. 服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。

###### 连通性

1. 注册中心，服务提供者，服务消费者三者之间均为长连接，监控中心除外；
2. 注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者；
3. 注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表；

###### 伸缩性

- 注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心
- 服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者

##### 04：用法

###### 本地服务 Spring 配置

local.xml:

```xml
<bean id=“xxxService” class=“com.xxx.XxxServiceImpl” />
<bean id=“xxxAction” class=“com.xxx.XxxAction”>
    <property name=“xxxService” ref=“xxxService” />
</bean>
```

###### 远程服务 Spring 配置

- 将上面的 `local.xml` 配置拆分成两份，**将服务定义部分放在服务提供方 `remote-provider.xml`，将服务引用部分放在服务消费方 `remote-consumer.xml`。**
- 并在**提供方增加暴露服务配置 `<dubbo:service>`，在消费方增加引用服务配置 `<dubbo:reference>**`。

remote-provider.xml:

```xml
<!-- 和本地服务一样实现远程服务 -->
<bean id=“xxxService” class=“com.xxx.XxxServiceImpl” /> 
<!-- 增加暴露远程服务配置 -->
<dubbo:service interface=“com.xxx.XxxService” ref=“xxxService” /> 
```

remote-consumer.xml:

```xml
<!-- 增加引用远程服务配置 -->
<dubbo:reference id=“xxxService” interface=“com.xxx.XxxService” />
<!-- 和本地服务一样使用远程服务 -->
<bean id=“xxxAction” class=“com.xxx.XxxAction”> 
    <property name=“xxxService” ref=“xxxService” />
</bean>
```
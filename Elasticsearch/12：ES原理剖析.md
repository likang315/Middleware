### ES 原理剖析

------

##### 01：为什么需要搜索引擎

- 带有关键词模糊查询时，不想数据库逐行扫描；

##### 02：搜索引擎

- 在插入数据时，对关键词进行了分类；，这样在查询数据时就可以快速的检索出来；
- 搜索引擎可分为三个过程：**分析、索引和搜索**。
  - 分析：是**通过一定的分析算法把字段的值切分为Term的过程**。
  - 索引（indexing）：是将**数据源通过一定方式提取信息，建立倒排索引的过程**。
  - 搜索（search）：是根据用户查询请求，**搜索创建的索引，返回索引内容**的过程。

##### 03：分析

- 具体的分析算法有很多种，会把单次缩减为词根形式，去掉助词，语气词；

##### 04：Lucene 倒排索引

- 倒排索引的创建过程就是**建立Term到文档ID的映射关系**；

##### 05：搜索过程

- **倒排索引逻辑结构图**
- ![倒排索引逻辑结构图](/Users/likang/Code/Git/Middleware/Elasticsearch/photos/倒排索引逻辑结构图.jpg)

- **倒排索引存储结构图**
- ![倒排索引存储结构图](/Users/likang/Code/Git/Middleware/Elasticsearch/photos/倒排索引存储结构图.png)

- 检索过程
  1. 用户输入查询语句；
  2. 对查询语句进行**语法分析和语言分析， 得到一系列Term**。
     - 确定各个Term的搜索字段，例如：北京香山；
     - 确定Term之间的模式（AND还是OR），是与还是且；
     - 用户自定义条件，如排序、分页等
  3. 通过语法分析得到一个**倒排索引**；
  4. 搜索到的结果文档**按查询的相关性进行排序**；
  5. 返回查询结果给用户；

##### 06：结果排序

- Lucene支持相关性分数排序和自定义排序。

###### 相关性分数排序

- 指的是**按搜索关键词（Term）与搜索结果之间的相关性所进行的排序**。例如，搜索bookname域中包含Java的图书，则根据Java在bookname中**出现的次数和位置**来判断结果的相关性；

###### 自定义排序

- 根据用户指定的字段进行排序，进行**排序的字段的store属性值必须是true**。








### 搜索

------

##### 01：概述

- Elasticsearch不只会存储(store)文档，也会索引(indexes)文档内容来使之可以被搜索。
- 每个文档里的字段都会被索引并被查询。

###### 特性

- **结构化查询：**可以像SQL一样使用结构化查询；
- **全文检索**：可以使用所有字段来匹配关键字，然后按照关联性(relevance)排序返回结果；

###### 概念解释

| 概念                        | 解释                           |
| --------------------------- | ------------------------------ |
| 映射(Mapping)               | 数据在每个字段中的解释说明     |
| 分析(Analysis)              | 全文是如何处理的，可以被搜索的 |
| 领域特定语言查询(Query DSL) | Elasticsearch强大的查询语言    |

##### 02：基本概念和机制

- 执行搜索时，ES将**根据内部的选择公式选择数据的“最佳”副本**。或者通过提供**路由参数routing**来控制要搜索的分片。

- **路由参数可以是多值的，用逗号分隔的字符串表示**，这将会命中路由值匹配的相关分片；

- ```shell
  POST /es/_doc?routing=123
  ```

###### 协调节点：

- 默认情况下，Elasticsearch将使用所谓的“自适应副本选择”机制。这样，协调节点（接受请求的节点）可以根据多个条件将请求发送到被视为“最佳”的副本。

- 动态更改集群设置

  - cluster.routing.use_adaptive_replica_selection："false"

    - 是否启用自适应副本选择机制；

  - ```sh
    PUT /_cluster/settings
    {
      "transient": {
          "cluster.routing.use_adaptive_replica_selection":true
      }
    }
    ```

    - 如果关闭“自适应副本选择”机制，则在所有数据副本（主分片和副本）之间以**循环方式**将搜索发送到相关分片；

  - default_search_timeout

    - 每个请求的超时时间，超时则取消检索，默认值为无全局超时，把此值设置为-1将全局搜索超时重置为无超时；

  - max_concurrent_shard_requests

    - 用于控制每个节点的**最大并发分片请求数**，此参数应用于保护单个请求不会造成集群负载过高；

##### 03：搜索API【_search】

- 允许用来执行**搜索查询并返回匹配的结果**，可以使用**简单查询字符串**作为参数提供查询（URI形式），也可以使用**请求正文（body形式）**。

- 所有搜索API都支持跨索引机制，并支持多索引语法

  - ```sh
    GET /twitter/_search
    # 多个索引
    GET /kimchy,Elasticsearch/_search
    # 所有索引中
    GET /_all/_search?q=tag:wow
    ```

- 为了确保快速响应，如**果一个或多个分片失败，搜索API将以部分结果响应**。

###### URL 模式

- 











###### body 模式
### 搜索

------

##### 01：概述

- Elasticsearch不只会存储(store)文档，也会索引(indexes)文档内容来使之可以被搜索。
- 每个文档里的字段都会被索引并被查询。

###### 特性

- **结构化查询：**可以像SQL一样使用结构化查询；
- **全文检索**：可以使用所有字段来匹配关键字，然后按照关联性(relevance)排序返回结果；

###### 概念解释

| 概念                        | 解释                           |
| --------------------------- | ------------------------------ |
| 映射(Mapping)               | 数据在每个字段中的解释说明     |
| 分析(Analysis)              | 全文是如何处理的，可以被搜索的 |
| 领域特定语言查询(Query DSL) | Elasticsearch强大的查询语言    |

##### 02：基本概念和机制

- 执行搜索时，ES将**根据内部的选择公式选择数据的“最佳”副本**。或者通过提供**路由参数routing**来控制要搜索的分片。

- **路由参数可以是多值的，用逗号分隔的字符串表示**，这将会命中路由值匹配的相关分片；

- ```shell
  POST /es/_doc?routing=123
  ```

###### 协调节点：

- 默认情况下，Elasticsearch将使用所谓的“自适应副本选择”机制。这样，协调节点（接受请求的节点）可以根据多个条件将请求发送到被视为“最佳”的副本。

- 动态更改集群设置

  - cluster.routing.use_adaptive_replica_selection："false"

    - 是否启用自适应副本选择机制；

  - ```sh
    PUT /_cluster/settings
    {
      "transient": {
          "cluster.routing.use_adaptive_replica_selection":true
      }
    }
    ```

    - 如果关闭“自适应副本选择”机制，则在所有数据副本（主分片和副本）之间以**循环方式**将搜索发送到相关分片；

  - default_search_timeout

    - 每个请求的超时时间，超时则取消检索，默认值为无全局超时，把此值设置为-1将全局搜索超时重置为无超时；

  - max_concurrent_shard_requests

    - 用于控制每个节点的**最大并发分片请求数**，此参数应用于保护单个请求不会造成集群负载过高；

##### 03：搜索API【_search】

- 允许用来执行**搜索查询并返回匹配的结果**，可以使用**简单查询字符串**作为参数提供查询（URI形式），也可以使用**请求正文（body形式）**。

- 所有搜索API都支持跨索引机制，并支持多索引语法

  - ```sh
    GET /twitter/_search
    # 多个索引
    GET /kimchy,Elasticsearch/_search
    # 所有索引中
    GET /_all/_search?q=tag:wow
    ```

- 为了确保快速响应，如**果一个或多个分片失败，搜索API将以部分结果响应**。

###### URL 模式

- 通过提供请求参数，可以纯粹使用URI执行搜索请求。在**使用此模式执行搜索时，并非所有搜索选项都可用**
  - q：查询字符串（映射到query_string 查询）
- 不建议使用，用于快速测试；

##### 04：body 模式

- 搜索请求可以在请求正文中使用Query DSL；

###### body 支持的参数

- batched_reduce_size

  - 用于限制协调节点一次批处理的分片数量，如果命中的分片数量大于此值，则会分批执行，默认值为512；

- timeout

  - 超时直接返回；

- terminate_after

  - 每个节点可以收集的最大文档数，默认无限制；
  - 如果查询提前终止，则在响应中 terminated_early 值true；

- **size**

  - 返回结果的数量，默认10；

- GET 请求都可用于发送带body 的请求；

  - 响应中 took 表示：处理此请求所用的毫秒数；

- ```sh
  GET /es/_doc/_search
  {
      "query" : {
          "match" : {
              "name" : "kang"
          }
      }
  }
  ```

###### Explain 参数

- 用来帮助**分析文档的相关性分数是如何计算出来的**，和数据库一致；
- 响应的结果就是对文档计算得到的总分以及总分的计算过程，以及不同打分项的描述信息，最重要的两个因子，词频和文档频率；
  - number of documents containing term： 词频数（在该字段中出现词数）
  - total number of documents with field：带有该字段的文档总数；
  - occurrences of term within document：文档数(整个索引中出现该词的文档数)

###### 折叠结果

- 允许基于**字段值折叠（collapse）搜索结果**。折叠是通过每个折叠键仅选择顶部排序的文档来完成的。其实就是**按照某个字段分组，每个分组只取一条结果;**

- ```sh
  GET es/_search
  {
    "query": {
      "match": {
        "name": "likang"
      }
    },
    "collapse": {
      "field": "age"
    },
    "sort": ["age"]
  }
  ```

- 响应中的命中total指示匹配文档的数量，是非折叠的结果，折叠后的数量）的总数是未知的；

- 用于折叠的字段必须是**单值keyword或数字numeric字段，而且doc_values属性开启**。

###### 分页

- 使用from和size参数对结果进行分页。
- from参数定义**要获取的第一个结果的偏移量**，size参数表示要**返回的最大结果**的数量;
- from+size 不能超过 **index.max_result_window** 参数设置的值，后者的默认值为10000。

###### 高亮结果

- 高亮器（Highlighter）用来**标识出搜索结果中的一个或多个字段中需要突出显示的部分**；

- 当请求中包括高亮的参数设置时，响应结果包含每个搜索命中的高亮元素，其中包括**突出显示的字段和突出显示的片段**。

- ```sh
  GET /_search
  {
    "query": {
      "match": {
        "name": "likang"
      }
    },
    "from": 1, "size":3,
    "highlight": {
        "fields": {
            "name": {}
        }
    }
  }
  ```

- Elasticsearch支持三种高亮器，实际应用中，可以为每个字段指定不同的高亮；

  1. unified（基于BM25算法的高亮器）
     - 使用的是Lucene Unified Highlighter。这个高亮器将文本分成句子，并使用BM25算法对单个句子进行评分，就如同它们是语料库中的文档。这是默认的高亮器
  2. plain（Lucene标准高亮器）
  3. fvh（快速矢量高亮器）

###### 高亮器的内部工作原理

1. 怎样切割文档成片段
2. 如何找到最佳片段
3. 如何高亮片段中的查询词

###### 索引加权

- 当在多个索引中搜索时，可以使用参数 `indices_boost` 来提升整个索引的权重，当**来自一个索引的命中文档比来自另一个索引的更重要**

- ```
  GET /_searh
  {
    "indices_boost": [
      {
        "index1": 1.5,
        "index2": 2
      }
    ],
    "query": {
        "match":{
            "name": "likang"
        }
    }
  }
  ```

######  命中文档嵌套

- 




































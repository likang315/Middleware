### 子查询

------

​	子查询是指包含在另一个SQL语句（包含语句）内部的查询。子查询总是**由括号包围， 并且通常在包含语句之前执行**。 子查询返回类型的结果集；

- 单列单行；
- 单列多行；
- 多列多行；

  子查询返回的结果集类型决定了它可能**如何被使用以及包含语句可能使用哪些运算符来处理子查询返回的数据**。任何子查询返回的数据在包含语句执行完成后都会被丢弃，这使子查询像一个**具有作用域的临时表**。

##### 01：子查询类型

​	 除了按照子查询结果集类型划分， 还可以基于另外一个因素划分子查询： 

- 非关联子查询：一些子查询完全独立；
- 关联查询：引用**包含语句**的列；

##### 02：非关联子查询

###### 单行单列子查询

- **标量子查询**：返回的都是一个单行单列的表；
- 等式条件中使用标量子查询；

###### 多行单列子查询

- 使用 IN，NOT IN 包含查询条件；
- **ALL 运算符**：用于将某单值与**集合中的每个值**进行比较，构键这样的条件需要将其中一个比较运算符与All 配合使用；
  - <> ALL : 包含查询的结果集不等于子查询的中任意一个；
- **ANY 运算符**：将一个值与值集中的每个成员进行比较，但是 ANY 运算符只要有一个比较成立，则条件为真，而 ALL 是所有成立才为真；

###### 多列子查询

- 例：select * from local_student_info where (class_id, age) <> (1001, 22);
  - 第一个字段与值集中第一个值比较，第二个字段与值集中第二个值比，依次类推；

##### 03：关联子查询

- 关联子查询不是在包含语句执行之前一次执行完毕，而是为每一个候选行（该行可能会包含在最终的结果集里）执行一次；

- 查询学生班级在班级信息表里存在的学生信息；

- ```sql
  SELECT *
  FROM local_student_info stu
  WHERE stu.class_id = (SELECT class_id FROM local_class class WHERE stu.class_id = class.class_id);
  ```

  - 子查询最后引用class.class_id  使之具有关联性；
  - 执行过程：先从stu表中检索出所有的学生信息，接着为每个学生执行一次子查询，**每次执行包含查询都哟要向子查询传递 class_id**，若子查询返回值等于class_id，则满足过滤条件，改行将被添加到结果集中。

- 查询class_id 在 0到1001之间的班级学生信息

- ```sql
  SELECT *
  FROM local_student_info stu
  WHERE (SELECT class_id FROM local_class class WHERE stu.class_id = class.class_id) BETWEEN 0 AND 1001;
  ```

###### exists 运算符

- 用于检查子查询是否有记录，如果有一条或多条记录存在返回 True，否则返回 False。

- ```sql
  SELECT *
  FROM local_student_info stu
  WHERE exists(SELECT 1 FROM local_class class where class_id = 1001)
  ```

  - select 1 from 中的1是一常量（可以为任意数值），查到的所有行的值都是它，**但从效率上来说，1>anycol>\*，因为不用查字典表**。 
  - 该子查询只需要知道返回的结果是多少行，而与结果的确切内容无关；

###### NOT  exists 运算符

- 用于检查子查询返回的行数是否是0；

###### 关联子查询操作数据

- 子查询页大龄应用于update，delete，insert 语句；

- ```sql
  UPDATE account a
  SET a.last_activity_date = (SELECT MAX(t.txn_date) FROM transaction t WHERE t.account_id = a.account_id)
  WHERE EXISTS (SELECT 1 FROM transaction t WHERE t.account_id = a.account_id);
  ```

  - set 子句的子查询仅当update语句中的where 子句为真时才执行（意味着至少能查找到依次这个账户的交易记录），这样就可以保护last_activity_date 列不被null 重写；

  ```sql
  DELETE FROM department d
  WHERE NOT exists(SELECT 1 FROM employee e WHERE e.dept_id = d.dept.id);
  ```

  - Mysql 中delete 语句在使用关联查询时，不能使用表别名；

##### 04：何时使用子查询

###### 子查询作为数据源

- 
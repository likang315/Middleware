### Transaction

------

##### 1：事务：访问并更新数据库中各种数据项的最小执行单元

###### ACID

1. 原子性(Atomic)：是一个不可分割的执行单元，要么全部成功，要么全部失败
2. 一致性(Consistency)：数据库的角度，数据库从一种一致性状态到另一种一致性状态
   - 原子性，一致性和和 Undo Log 来完成
3. 隔离性(Isolation)：事物之间相互隔离
   - 由锁来实现
4. 持久性（Durabiliy）：事物一旦提交，持久化到磁盘中
   - 由 Redo Log 实现

Redo Log 用于保障已提交事务的 ACID 特性, Undo log 用于保障未提交的事务不会对数据库的ACID 特性产生影响

##### 2：事物的实现

1. ###### Redo Log (重做日志）：用来实现事务中的持久性, 由两部分组成：

   - 内存中的重做日志缓冲(redo log buffer) 
   - 磁盘中的重做日志文件(redo log file) ，其是持久的
   - 当事务提交的时候, 必须先将该事务的所有日志写入到磁盘中的重做日志文件进行持久化，待事务提交结束才算完成

2. ###### Undo Log（回滚日志）：记录了事务的行为, 可以很好的对页进行 "回滚" 操作,

   -  undo log 存放在数据库内部的undo段中, 位于共享表空间 
   - 回滚日志的主要工作是将数据库逻辑地恢复到原来的样子, 但数据结构和页本身在回滚之后可能和事务开始前不太相同，因为与此同时有大量的并发事务存在, 不能简单的将一个页回滚到事务开始时的样子, 否则会影响其他事务，恢复行记录
   - Undo Log 的另一个功能是 MVCC，当需要读取的记录已经被其他事务加锁的时候, 当前事务可以通过 undo 读取之前的版本, 以此实现一致性非锁定读

##### 3：事务隔离级别

​	隔离级别有 4 个，由低到高依次为 

- Read uncommitted
- Readcommitted
  - 解决更新丢失
- Repeatable read
  - 脏读
  - 默认的隔离级别
- Serializable
  - 不可重复读，幻读

###### 项目中一般用，读已提交 作为 默认的隔离级别

1. 主从复制的 bin log，有三种格式
   - statement：记录修改的Sql语句
   - row：记录每行记录实际数据的变更
   - mixed：两种混合模式
2. 在statement格式下，读已提交这种隔离级别的主从复制，会出现错误的（master上执行先删后插，slave执行的是先插后删），会导致主从不一致，因此用**可重复读，在级别下引入了间隙锁**，或者选用 **row 作为 binlog  的格式**
3. 若使用串行化，事务一个一个按顺序执行，每次读都会加锁，导致快照读失效

##### 4：当前读、快照读

- 在RR级别下，快照读是通过MVVC(多版本控制)和undo log来实现的，当前读是通过加record lock(记录锁)和gap lock(间隙锁)来实现的
- 在 RR 级别下：MVCC完全解决了重复读，但不能真正的完全避免幻读，只是在利用**历史数据规避了幻读**
- 对于快照读，mysql使用历史数据部分避免了幻读，若需完全避免，需要手动加锁将快照读调整为当前读，然后mysql使用next-key完全避免了幻读

##### 5：主从复制

![](https://github.com/likang315/Java-and-Middleware/blob/master/Mysql%EF%BC%8CInnoDB/InnoDB/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.png?raw=true)

- 从库生成两个线程，**一个I/O线程，一个SQL线程**
- 主库会把通过**bin log 记录每行记录实际数据的变更**，I/O 线程去请求 主库 的bin log，主库会生成一个 **log dump 线程**，用来给从库 i/o线程传bin log，从库将得到的 bin log日志写入 Relay log（中继日志） 文件中，SQL 线程，会读取Relay log文件中的日志，并解析成具体操作，来实现主从的数据一致
- 两种复制原理
  1. 异步复制原理 ：
     - 主库提交事务后，立即返回客户端，它的同步是当有从库的I/O线程请求才传送 Bin log 的
  2. 半同步复制原理：
     - 主库在执行完客户端提交的事务后不是立刻返回给客户端，而是**等待至少一个从库接收到并写到relay log中才返回给客户端**，相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟

###### 主从复制优缺点：

1. 灾容性好，用于故障切换，和恢复数据库
2. 读写分离，提供查询服务
3. 从库**只有一个sql Thread**，主库写压力大，复制很可能延时，通过并行复制解决

######  主从复制方式

- 一主一从
- 一主多从，读是在从库读取的
- 主主复制
- 多主一从
- 联级复制
### 原子操作的实现原理

------

​	原子操作（atomic operation）：不可被中断的一个或一系列操作

##### 1：处理器实现原子操作

- 基于对缓存加锁或总线加锁的方式来实现多处理器之间的原子操作
- 首先处理器会自动保证基本的内存操作的原子性。处理器保证从系统内存中读取或者写入一个字节是原子的

###### 使用总线加锁保证原子性

- 两次 i++ 操作结果可能是2，可能是多个处理器同时从各自的缓存中读取变量i，分别进行加1操作，然后分别写入系统内存中。那么，想要保证读改写共享变量的操作是原子的，就必须保证CPU1读改写共享变量的时候，CPU2不能操作缓存了该共享变量内存地址的缓存
- 总线锁就是使用处理器提供的一个**LOCK＃信号**，当一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞住，那么该处理器可以独占共享内存

###### 使用缓存锁保证原子性

- 总线锁定把CPU和内存之间的通信锁住了，这使得锁定期间，其他处理器不能操作其他内存地址的数据，所以总线锁定的开销比较大，已经不适合扩展
- **缓存锁定**：是指内存区域如果被缓存在处理器的缓存行中，并且在Lock操作期间被锁定，那么当它执行锁操作回写到内存时，处理器不在总线上声言LOCK＃信号，而是修改内部的内存地址，并允许它的缓存一致性机制来保证操作的原子性
- 因为缓存一致性机制会阻止同时修改由两个以上处理器缓存的内存区域数据，当其他处理器回写已被锁定的缓存行的数据时，会使缓存行无效

##### 2：Java 中实现原子操作

​	在Java中可以通过**锁和循环CAS**的方式来实现原子操作

###### 使用锁机制实现原子操作

​	锁机制保证了只有获得锁的线程才能够操作锁定的内存区域。JVM内部实现了很多种锁机制，有偏向锁、轻量级锁和互斥锁